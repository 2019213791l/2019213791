<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <meta charset="utf-8">
        <title>期末大作业</title>
        <script>
            //获取屏幕的宽度、高度,根据设计图中的canvas画布的占比进行设置
            var clientWidth = document.documentElement.clientWidth/1.2;
            var clientHeight = document.documentElement.clientHeight;
            
            var mybox=[];           //存放动态创建的每个小格子
            var value=[];           //存放动态创建的每个小格子的高度的值
        //    var gao=[0,3,44,38,5,47,15,36,26,27,2,46,4,19,50,48];    //存放每一小格的高度
        //    3 44 38 5 47 15 36 26 27 2 46 4 19 50 48
            var gao=[0];
            var select1=1;           //选择一个方块进行移动
            var select2=0;

            var Y=Math.floor(clientHeight)*2/5;     //表示每一个小格的Y轴开始位置
    //        var Width=Math.floor(clientWidth)*1/gao.length/2.5; //myArea.canvas.width/20;    ------表示每一个小格的宽度
            var myArea={
                canvas:document.createElement("canvas"),
                start:function(){
                    this.canvas.width=Math.floor(clientWidth)*4/5;
                    this.canvas.height=Math.floor(clientHeight)*4/5;

                    this.canvas.style.border="2px solid #BC8EBD";
                    this.canvas.style.background="#EFBCCD";                    
                    this.context=this.canvas.getContext("2d");

                    document.body.insertBefore(this.canvas,document.body.childNodes[0]);
                    this.frameNo=0;
                //    this.interval=setInterval(updateArea,20);
                },
                clear:function(){
                    this.context.clearRect(0,0,this.canvas.width,this.canvas.height);
                },
                stop:function(){
                    clearInterval(this.interval);
                }
            }

            function StartLoad()
            {
                myArea.start();
                
                //计算小格子高度的总和，便于后续设置每个小个子的高度，防止溢出

                
            }

            function produce()
            {
                let text=document.getElementById("text");
                let num=0;

                for(var i=0;i<text.value.length;i++){              
                    if(isNum(text.value[i]))
                    {
                        num=num+text.value[i]-'0';
                    }
                    else
                    {
                        gao.push(num);
                        num=0;
                    }                              
                }
                if(num!=0)
                gao.push(num);

                var Width=Math.floor(clientWidth)*1/gao.length/2.5; //myArea.canvas.width/20;    ------表示每一个小格的宽度

                let max=getMax(gao);
                console.log(max);

                //创建每个小格子  0位置不用，但占着作为中间变量
                mybox.push(new component(0,0,0,"white",0,0));
                value.push(new component(0));

                for(let i=1;i<gao.length;i++)
                {

                        mybox.push(new component(i,Width,-gao[i]*myArea.canvas.height/max/4,"#BC8EBD",i*2*Width,Y,"box",gao[i]))
                        value.push(new component(i,Width,20,"black",i*2*Width,Y,"text",gao[i],"17px"))
                       
                 }
            }

            function component(id,width,height,color,middle,y,type,text,size)
            {
                
                this.id=id;
                this.flag=1;        //1:本位    2：下移位   3:左右移动位    4.新位置
                this.width=width;
                this.height=height;

                this.color=color;
                this.middle=middle;                 //辅助变量
                this.originMiddle=middle;           //记录每个固定分好的的格子          
                this.y=y;
                this.type=type;
                this.text=text;
                this.size=size;
                 
                ctx=myArea.context; 

                if(type=="text"){
                    this.x=this.middle;
                    ctx.font=this.size+" Consolas";
                    ctx.fillStyle=color;
                    ctx.fillText(this.text,this.x,this.y);
                }
                else{
                    this.x=this.middle-this.width/2;  
                    ctx.fillStyle=color;
                    ctx.fillRect(this.x,this.y,this.width,this.height);                    
                } 

                this.update=function(){
                    ctx=myArea.context; 

                    if(type=="text"){
                        this.x=this.middle;
                        ctx.font=this.size+" Consolas";
                        ctx.fillStyle=color;
                        ctx.fillText(this.text,this.x,this.y);
                    }
                    else{
                        this.x=this.middle-this.width/2;  
                        ctx.fillStyle=color;
                        ctx.fillRect(this.x,this.y,this.width,this.height);                    
                    }                    
                }
                this.newPos=function(){
                    if(select1!=0 && select2!=0)
                    {
                        if(select1==this.id){

                            if(this.flag==1){
                                if(this.y<1.9*Y)
                                    this.y+=3;
                                else    
                                    this.flag=2;  
                                                            
                            }

                            if(this.flag==2){ 
                                if(this.middle>mybox[select2].originMiddle){
                                    this.middle-=1;
                                    if(this.type=="text")
                                        this.x=this.middle;
                                    else
                                        this.x=this.middle-this.width;
                                }                          
                                else
                                    this.flag=3;                               

                            }
                            if(this.flag==3){

                                if(this.y>Y)
                                    this.y-=3;
                                else  
                                    this.flag=4;                           
                            }

                            if(this.flag==4)
                            {
                                this.color="white";//-----------------------------------?
                                //this.originMiddle=this.middle;
                            }                      
                        }                        
                    }

                    if(select1!=0 && select2!=0)
                    {
                        if(select2==this.id){
                        //    console.log(mybox[select1].flag);
                        //    console.log(mybox[select1].flag===1);
                            if(this.flag==1){
                                this.color="yellow";//---------------------------------?
                                if(mybox[select1].flag>=2)
                                {
                                    if(this.middle<mybox[select1].originMiddle){

                                        this.middle+=1;
                                        if(this.type=="text")
                                            this.x=this.middle;
                                        else
                                            this.x=this.middle-this.width/2;
                                    }
                                else
                                    this.flag=2;                                                            
                                }
                                else;
    

                            }   
                            else if(this.flag==2)
                            {
                                this.color="white";
                            }                    

                        }                        
                    }


                    if(mybox[select1].flag==4 && mybox[select2].flag== 2)
                    {
                        swapArr(mybox,select1,select2);
                        swapArr(value,select1,select2);

                        //一定要记得修改id！！！！
                        let id=mybox[select1].id;
                        mybox[select1].id=mybox[select2].id;
                        mybox[select2].id=id;

                        let id1=value[select1].id;
                        value[select1].id=value[select2].id;
                        value[select2].id=id1;

                        let middle=mybox[select1].originMiddle;
                        mybox[select1].originMiddle=mybox[select2].originMiddle;
                        mybox[select2].originMiddle=middle;

                        mybox[select1].middle=mybox[select1].originMiddle;
                        mybox[select2].middle=mybox[select2].originMiddle;
                        
                        let g=gao[select1];
                        gao[select1]=gao[select2];
                        gao[select2]=g;

                    /*    mybox[select1].flag=1;
                        mybox[select2].flag=1;
                        select1=0;
                        select2=0;*/
                    }

                    

                }

            }
            console.log(gao);
            function updateArea()
            {
                myArea.clear();
                myArea.frameNo++;
                while(select1<=mybox.length)
                {
                    let i;
                    for(i=select1;i>0;i--)
                        if(gao[i]>gao[select1])
                            break;
                    if(i!=0)
                    {
                        select2=i;       
                        break;                         
                    }
                    
                    else
                    {
                        select1++;
                    }

                }
          //      select1=4;
            //    select2=2;
                if(select1>mybox.length)
                {
                    select1=0;
                    select2=0;
                }
                for(let i=1;i<gao.length;i++)
                {
                    mybox[i].newPos(); 
                    value[i].newPos();
                    mybox[i].update();       
                    value[i].update();
                }

                
                if(mybox[select1].flag==2 && mybox[select2].flag== 4)
                {
                    //反着的
                    mybox[select1].flag=1;
                    mybox[select2].flag=1;
                    value[select1].flag=1;
                    value[select2].flag=1;

                }
            }

            function swapArr(arr, index1, index2) {
                arr[index1] = arr.splice(index2, 1, arr[index1])[0];
                return arr;
            }

            function getMax(arr)
            {
                let max=0;
                for(let i=0;i<arr.length;i++)
                {
                    if(max<arr[i])
                    max=arr[i];
                }
                return max;
            }
            
            function intervalStart()
            {
                setInterval(updateArea,7);
            }

            function isNum(x)
            {
                if((x=='0') || (x=='1')|| (x=='2')|| (x=='3')|| (x=='4')|| (x=='5')|| (x=='6')|| (x=='7')|| (x=='8')|| (x=='9'))
                return true;
                else
                return false;
            }
        </script>
    </head>

    <body onload=StartLoad()>
        <div>
            <input onkeyup="value=value.replace(/[^\0-9\.]/g,'')" onpaste="value=value.replace(/[^\0-9\.]/g,'')" 
            oncontextmenu = "value=value.replace(/[^\0-9\.]/g,'')" type="text" id="text" name="text" maxlength="100">
            
            <button onmousedown="produce()">生成柱状图</button>
            <button onmousedown="intervalStart()">点击开始</button>
        </div>
       
    </body>
</html>